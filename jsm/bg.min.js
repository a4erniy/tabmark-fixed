function install(a){var b={backgrounds:a.backgrounds,logos:a.logos,tabs:a.defaults.tabs,dials:a.defaults.dials,settings:a.defaults.settings};chrome.storage.local.set(b,function(){_gaq.push(["_trackEvent","browser","install"]),localStorage.installed=!0,bg.finish()})}function makeThumbnail(a,b,c){setTimeout(function(){var b=db.g("requestThumb");b&&chrome.tabs.query({currentWindow:!0,active:!0},function(d){var e=helper.getHostname(b.url,!0),f=helper.getHostname(d[0].url,!0);if(e!=f)return void(30>=c&&makeThumbnail(b,2e3,c+1));try{chrome.tabs.captureVisibleTab(chrome.windows.WINDOW_ID_CURRENT,{format:"png"},function(b){helper.resizeImage(b,460,function(b){db.load("dials");var c=_.find(db.store.dials,{id:a.dialId});c.imgUrl=b,c.favIconUrl=d[0].favIconUrl,db.save("dials"),db.s("requestThumb",!1)})})}catch(g){}})},b)}var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-56289433-1"]),_gaq.push(["_trackEvent","browser","browser-open"]),function(){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src="https://ssl.google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}(),setInterval(function(){_gaq.push(["_trackEvent","app","app-keep-online"])},3e5);var templates={list:{tab:null,dial:null,modal:null,createTabModal:null,deleteTabModal:null,createDialModal:null,deleteDialModal:null,optionsBg:null,optionsGen:null,optionsIE:null,chromeApp:null,updateLog:null},init:function(){_.each(templates.list,function(a,b){null!=templates.list[b]?templates.list[b]=Handlebars.compile(templates.list[b]):$.get("/tmp/"+b+".html").success(function(a){templates.list[b]=Handlebars.compile(a)})})}};templates.init(),bg={isReady:!1,onReady:null,init:function(){helper.ajax({url:"http://tabmark.me/data/data.json",success:function(a){a=JSON.parse(a),backgrounds=a.backgrounds,logos=a.logos,"undefined"==typeof localStorage.installed?install(a):bg.finish()},error:function(){chrome.storage.local.get(["backgrounds","logos"],function(a){backgrounds=a.backgrounds,logos=a.logos,bg.finish()})}})},finish:function(){db.init(),bg.isReady=!0}},bg.init(),chrome.runtime.onInstalled.addListener(function(a){"update"==a.reason&&(_gaq.push(["_trackEvent","browser","ext-update-v"+chrome.app.getDetails().version]),DB.set("showUpdateLog",!0))}),chrome.tabs.onUpdated.addListener(function(a,b){if("complete"==b.status){var c=db.g("requestThumb");c&&makeThumbnail(c,2e3,1)}});var tabFavicons={};chrome.tabs.onUpdated.addListener(function(a){chrome.tabs.get(a,function(a){0!=a.url.indexOf("chrome://newtab/")&&(tabFavicons[helper.getHostname(a.url,!0)]=a.favIconUrl)})}),chrome.tabs.onUpdated.addListener(function(a,b,c){var d=helper.parseUrl(c.url),e=["amazon.com","amazon.co.uk","amazon.fr","amazon.de","amazon.in","amazon.it","amazon.es","asos.com","rosewe.com","ebay.com","ebay.co.uk","jabong.com","aliexpress.com"],f=d.hostname.replace(/^www\./,"");e.indexOf(f)>-1&&_gaq.push(["_trackEvent","site",f,c.url]),0==c.url.indexOf("http")&&chrome.pageAction.show(a)});